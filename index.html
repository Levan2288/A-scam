<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Coin Voentorg | Arma 3</title>
    
    <!-- Подключение Tailwind CSS для быстрого и красивого дизайна -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение иконок Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Глобальные настройки цвета */
        :root {
            /* ИЗМЕНИ ЭТОТ ЦВЕТ, чтобы поменять тему всего сайта */
            --main-color: #c1a270; /* Красный (Red-600) как пример агрессивного/военного стиля */
            --main-color-hover: #a68a5a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6; /* Светло-серый фон */
        }

        /* Утилиты для использования CSS переменной в Tailwind */
        .bg-main { background-color: var(--main-color); }
        .bg-main:hover { background-color: var(--main-color-hover); }
        .text-main { color: var(--main-color); }
        .border-main { border-color: var(--main-color); }

        /* Скрываем скроллбар для меню но оставляем функционал */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Анимация загрузки */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--main-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Уведомления (Toasts) -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- ЭКРАН ЗАГРУЗКИ / АВТОРИЗАЦИИ -->
    <div id="auth-screen" class="fixed inset-0 z-40 bg-white flex items-center justify-center transition-opacity duration-500">
        <div class="w-full max-w-md p-8 bg-white shadow-2xl rounded-xl border-t-4 border-main">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">A-COIN <span class="text-main">VOENTORG</span></h1>
            <p class="text-center text-gray-500 mb-8">Система снабжения и торговли</p>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Позывной (Логин)</label>
                    <input type="text" id="login-username" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Пароль доступа</label>
                    <input type="password" id="login-password" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500" required>
                </div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-main focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors">
                    Войти в систему
                </button>
            </form>
            <p id="auth-error" class="mt-4 text-center text-red-600 text-sm hidden"></p>
        </div>
    </div>

    <!-- ОСНОВНОЙ ИНТЕРФЕЙС -->
    <div id="app-interface" class="flex h-full hidden">
        
        <!-- Боковое меню (Sidebar) -->
        <aside class="w-64 bg-white shadow-lg z-30 hidden md:flex flex-col h-full">
            <div class="p-6 border-b border-gray-100 flex items-center gap-2">
                <i data-lucide="shield" class="text-main w-8 h-8"></i>
                <span class="text-xl font-bold tracking-wider">ARMORY</span>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-3">
                    <li><button onclick="router.navigate('shop')" class="nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-600 hover:bg-gray-50 hover:text-main transition-colors font-medium"><i data-lucide="shopping-bag" class="w-5 h-5"></i> Военторг</button></li>
                    <li><button onclick="router.navigate('inventory')" class="nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-600 hover:bg-gray-50 hover:text-main transition-colors font-medium"><i data-lucide="backpack" class="w-5 h-5"></i> Мой инвентарь</button></li>
                    <li><button onclick="router.navigate('wallet')" class="nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-600 hover:bg-gray-50 hover:text-main transition-colors font-medium"><i data-lucide="arrow-right-left" class="w-5 h-5"></i> Переводы (P2P)</button></li>
                    <li id="admin-link" class="hidden"><button onclick="router.navigate('admin')" class="nav-btn w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-600 hover:bg-red-50 hover:text-red-600 transition-colors font-medium"><i data-lucide="settings" class="w-5 h-5"></i> Админ Панель</button></li>
                </ul>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <p class="text-xs text-gray-500 uppercase">Ваш баланс</p>
                    <div class="flex items-baseline gap-1">
                        <span id="sidebar-balance" class="text-xl font-bold text-gray-800">0.00</span>
                        <span class="text-xs font-bold text-main">A-COIN</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Курс: <span id="sidebar-rate">...</span> $</p>
                </div>
                <button onclick="auth.logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm text-red-600 border border-red-100 rounded-lg hover:bg-red-50 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Выход
                </button>
            </div>
        </aside>

        <!-- Мобильное меню (Toggle) -->
        <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 flex justify-around p-3 border-t">
            <button onclick="router.navigate('shop')" class="flex flex-col items-center text-gray-500 hover:text-main"><i data-lucide="shopping-bag" class="w-6 h-6"></i><span class="text-[10px]">Магазин</span></button>
            <button onclick="router.navigate('inventory')" class="flex flex-col items-center text-gray-500 hover:text-main"><i data-lucide="backpack" class="w-6 h-6"></i><span class="text-[10px]">Вещи</span></button>
            <button onclick="router.navigate('wallet')" class="flex flex-col items-center text-gray-500 hover:text-main"><i data-lucide="arrow-right-left" class="w-6 h-6"></i><span class="text-[10px]">Обмен</span></button>
            <button onclick="router.navigate('profile')" class="flex flex-col items-center text-gray-500 hover:text-main"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px]">Профиль</span></button>
        </div>

        <!-- Контентная область -->
        <main class="flex-1 h-full overflow-y-auto bg-gray-100 relative">
            <div id="content-area" class="p-4 md:p-8 pb-24 md:pb-8 max-w-7xl mx-auto">
                <!-- Сюда динамически рендерится контент -->
            </div>
        </main>
    </div>

    <!-- МОДУЛИ СКРИПТА -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, doc, 
            updateDoc, deleteDoc, query, where, runTransaction, 
            onSnapshot, setDoc, arrayUnion, arrayRemove, increment 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ==========================================
        // 1. КОНФИГУРАЦИЯ (Firebase Config)
        // ==========================================
        const firebaseConfig = {
            apiKey: "", // Оставлено пустым, так как среда выполнения подставит ключи, но для продакшена вставь свои
            authDomain: "your-project.firebaseapp.com",
            projectId: "a-coin-fb077",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789", 
            appId: "1:123456789:web:abcdef"
        };
        
        // ВАЖНО: В реальном проекте вставь свои данные конфигурации сюда! 
        // Если ты запускаешь это локально, замени объект выше на свой const firebaseConfig.

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ==========================================
        // 2. СЕРВИСЫ (Бизнес логика)
        // ==========================================

        // --- Управление Уведомлениями ---
        const Toast = {
            show(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
                el.className = `${colors} text-white px-6 py-3 rounded shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center gap-2`;
                el.innerHTML = `<span>${message}</span>`;
                
                container.appendChild(el);
                
                // Анимация появления
                requestAnimationFrame(() => {
                    el.classList.remove('translate-x-full', 'opacity-0');
                });

                // Удаление через 3 сек
                setTimeout(() => {
                    el.classList.add('opacity-0', 'translate-y-[-10px]');
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            }
        };

        // --- Сервис Авторизации ---
        class AuthService {
            constructor() {
                this.currentUser = null;
                this.isAdmin = false;
            }

            async login(username, password) {
                try {
                    const q = query(collection(db, 'users'), where('username', '==', username));
                    const snapshot = await getDocs(q);

                    if (snapshot.empty) {
                        // Хак для первого запуска: создаем админа если база пустая
                        const allUsers = await getDocs(collection(db, 'users'));
                        if (allUsers.empty && username === 'admin' && password === 'admin') {
                            await this.createFirstAdmin();
                            return this.login('admin', 'admin');
                        }
                        throw new Error('Пользователь не найден');
                    }

                    const userData = snapshot.docs[0].data();
                    const userId = snapshot.docs[0].id;

                    if (userData.password !== password) {
                        throw new Error('Неверный пароль');
                    }

                    this.currentUser = { id: userId, ...userData };
                    this.isAdmin = userData.role === 'admin';
                    
                    // Сохраняем сессию в localStorage (просто, небезопасно для банка, норм для игры)
                    localStorage.setItem('voentorg_user', JSON.stringify(this.currentUser));
                    
                    return true;
                } catch (e) {
                    console.error(e);
                    throw e;
                }
            }

            logout() {
                this.currentUser = null;
                this.isAdmin = false;
                localStorage.removeItem('voentorg_user');
                window.location.reload();
            }

            loadSession() {
                const stored = localStorage.getItem('voentorg_user');
                if (stored) {
                    this.currentUser = JSON.parse(stored);
                    this.isAdmin = this.currentUser.role === 'admin';
                    return true;
                }
                return false;
            }
        }

        // --- Сервис Экономики и Магазина ---
        class StoreService {
            async getItems() {
                const snapshot = await getDocs(collection(db, 'items'));
                return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            }

            async buyItem(userId, item) {
                // Транзакция для безопасной покупки
                try {
                    await runTransaction(db, async (transaction) => {
                        const userRef = doc(db, 'users', userId);
                        const userDoc = await transaction.get(userRef);

                        if (!userDoc.exists()) throw "User does not exist!";

                        const newBalance = userDoc.data().balance - item.price;

                        if (newBalance < 0) {
                            throw "Недостаточно средств (Not enough A-Coins)";
                        }

                        // Списываем средства
                        transaction.update(userRef, { balance: newBalance });
                        
                        // Добавляем предмет (В инвентарь сохраняем копию данных предмета, чтобы если админ удалит товар, у юзера он остался)
                        transaction.update(userRef, {
                            inventory: arrayUnion({
                                itemId: item.id,
                                name: item.name,
                                type: item.type,
                                description: item.description,
                                purchaseDate: new Date().toISOString()
                            })
                        });
                    });
                    Toast.show(`Куплено: ${item.name}`, 'success');
                    return true;
                } catch (e) {
                    Toast.show(e, 'error');
                    return false;
                }
            }

            async transferCoins(senderId, receiverUsername, amount) {
                amount = parseFloat(amount);
                if (isNaN(amount) || amount <= 0) {
                    Toast.show('Некорректная сумма', 'error');
                    return;
                }

                try {
                    await runTransaction(db, async (transaction) => {
                        // 1. Находим получателя по имени
                        const q = query(collection(db, 'users'), where('username', '==', receiverUsername));
                        const receiverSnap = await getDocs(q);
                        
                        if (receiverSnap.empty) throw "Получатель не найден";
                        const receiverDoc = receiverSnap.docs[0];
                        const receiverRef = receiverDoc.ref;

                        // 2. Получаем отправителя
                        const senderRef = doc(db, 'users', senderId);
                        const senderDoc = await transaction.get(senderRef);

                        if (senderDoc.data().balance < amount) throw "Недостаточно средств";

                        // 3. Переводим
                        transaction.update(senderRef, { balance: increment(-amount) });
                        transaction.update(receiverRef, { balance: increment(amount) });
                    });
                    Toast.show('Перевод выполнен успешно', 'success');
                } catch (e) {
                    Toast.show(`Ошибка перевода: ${e}`, 'error');
                }
            }

            async getExchangeRate() {
                // Логика ликвидности: Rate = Reserve / Total Supply
                try {
                    // Получаем резерв
                    const configSnap = await getDocs(collection(db, 'config'));
                    let reserve = 10000; // default
                    if(!configSnap.empty) {
                        configSnap.forEach(d => { if(d.id === 'economy') reserve = d.data().liquidity_reserve_usd; });
                    }

                    // Считаем Total Supply (в реале это лучше хранить в счетчике, но для простоты просуммируем)
                    const usersSnap = await getDocs(collection(db, 'users'));
                    let totalSupply = 0;
                    usersSnap.forEach(d => totalSupply += (d.data().balance || 0));

                    if (totalSupply === 0) return 1.00; // База
                    return (reserve / totalSupply).toFixed(2);
                } catch (e) {
                    console.error(e);
                    return "0.00";
                }
            }
        }

        // --- Админ Сервис ---
        class AdminService {
            async addUser(username, password, balance, role = 'user') {
                try {
                    // Проверка на уникальность имени
                    const q = query(collection(db, 'users'), where('username', '==', username));
                    const snap = await getDocs(q);
                    if (!snap.empty) throw "Пользователь с таким именем уже существует";

                    await addDoc(collection(db, 'users'), {
                        username, password, balance: parseFloat(balance), role, inventory: []
                    });
                    Toast.show('Пользователь создан', 'success');
                } catch (e) {
                    Toast.show(e, 'error');
                }
            }

            async addItem(itemData) {
                try {
                    await addDoc(collection(db, 'items'), itemData);
                    Toast.show('Товар добавлен', 'success');
                } catch(e) { Toast.show(e, 'error'); }
            }

            async deleteItem(itemId) {
                if(!confirm('Удалить товар?')) return;
                await deleteDoc(doc(db, 'items', itemId));
                Toast.show('Товар удален', 'success');
            }
            
            async updateLiquidity(amount) {
                 await setDoc(doc(db, 'config', 'economy'), { liquidity_reserve_usd: parseFloat(amount) }, { merge: true });
                 Toast.show('Резерв ликвидности обновлен', 'success');
            }

            async removeItemFromUser(userId, itemIndex, currentInventory) {
                // Удаление конкретного предмета из массива инвентаря
                // В Firestore удалять из массива объектов сложно, проще перезаписать массив
                const newInventory = [...currentInventory];
                newInventory.splice(itemIndex, 1);
                
                await updateDoc(doc(db, 'users', userId), { inventory: newInventory });
                Toast.show('Предмет изъят у пользователя', 'success');
            }
        }

        // ==========================================
        // 3. UI RENDERER (Отрисовка)
        // ==========================================
        
        const auth = new AuthService();
        const store = new StoreService();
        const admin = new AdminService();

        // Router
        const router = {
            current: 'shop',
            navigate(page) {
                this.current = page;
                renderApp();
                // Обновление активного класса в меню
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-main', 'bg-gray-50'));
                // (Простая логика подсветки опустим для краткости, главное контент)
            }
        };

        // Экспортируем router глобально для HTML onclick
        window.router = router;
        window.auth = auth;

        function setupListeners() {
            // Login Form
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const u = document.getElementById('login-username').value;
                const p = document.getElementById('login-password').value;
                try {
                    await auth.login(u, p);
                    initApp();
                } catch (err) {
                    const errEl = document.getElementById('auth-error');
                    errEl.textContent = err.message;
                    errEl.classList.remove('hidden');
                }
            });
        }

        async function initApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            document.getElementById('app-interface').classList.add('flex');
            
            if (auth.isAdmin) {
                document.getElementById('admin-link').classList.remove('hidden');
            }

            // Realtime слушатель баланса
            onSnapshot(doc(db, 'users', auth.currentUser.id), (doc) => {
                auth.currentUser = { id: doc.id, ...doc.data() }; // Update local state
                document.getElementById('sidebar-balance').textContent = auth.currentUser.balance.toFixed(2);
            });

            // Обновление курса
            const rate = await store.getExchangeRate();
            document.getElementById('sidebar-rate').textContent = rate;

            renderApp();
            lucide.createIcons();
        }

        async function renderApp() {
            const container = document.getElementById('content-area');
            container.innerHTML = '<div class="flex justify-center mt-10"><div class="loader"></div></div>';
            
            let html = '';

            switch(router.current) {
                case 'shop':
                    const items = await store.getItems();
                    html = `
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">Военторг</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${items.map(item => `
                                <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow p-5 border border-gray-100 flex flex-col">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="p-2 bg-gray-100 rounded-lg">
                                            ${getIconForType(item.type)}
                                        </div>
                                        <span class="font-bold text-main bg-red-50 px-2 py-1 rounded text-sm">${item.price} A</span>
                                    </div>
                                    <h3 class="font-bold text-lg text-gray-800">${item.name}</h3>
                                    <p class="text-gray-500 text-sm mb-4 flex-1">${item.description}</p>
                                    <button onclick="window.buy('${item.id}', '${item.price}')" class="w-full bg-gray-900 text-white py-2 rounded-lg hover:bg-main transition-colors font-medium">Купить</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;

                case 'inventory':
                    // Инвентарь берем из актуального стейта пользователя (обновляется через onSnapshot)
                    const inventory = auth.currentUser.inventory || [];
                    html = `
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">Личный состав / Инвентарь</h2>
                        ${inventory.length === 0 ? '<p class="text-gray-500">Инвентарь пуст. Посетите военторг.</p>' : ''}
                        <div class="space-y-3">
                            ${inventory.map(item => `
                                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-main flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        ${getIconForType(item.type)}
                                        <div>
                                            <h4 class="font-bold text-gray-800">${item.name}</h4>
                                            <p class="text-xs text-gray-400">${item.type} • Получено: ${new Date(item.purchaseDate).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded">В наличии</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;

                case 'wallet':
                    html = `
                        <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-sm">
                            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="arrow-right-left" class="w-5 h-5 text-main"></i> Перевод средств</h2>
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <p class="text-sm text-gray-500">Доступно</p>
                                <p class="text-2xl font-bold">${auth.currentUser.balance.toFixed(2)} A-COIN</p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Позывной получателя</label>
                                    <input type="text" id="transfer-username" class="w-full mt-1 p-2 border rounded focus:ring-main focus:border-main">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Сумма (A-Coin)</label>
                                    <input type="number" id="transfer-amount" class="w-full mt-1 p-2 border rounded focus:ring-main focus:border-main">
                                </div>
                                <button onclick="window.makeTransfer()" class="w-full bg-main text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors">Отправить средства</button>
                            </div>
                        </div>
                    `;
                    break;

                case 'admin':
                    if (!auth.isAdmin) { router.navigate('shop'); return; }
                    
                    // Загрузка данных для админки
                    const usersSnap = await getDocs(collection(db, 'users'));
                    const allUsers = usersSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    const itemsSnap = await getDocs(collection(db, 'items'));
                    const allItems = itemsSnap.docs.map(d => ({id: d.id, ...d.data()}));

                    html = `
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">Центр Управления (Admin)</h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Управление Товарами -->
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="font-bold text-lg mb-4 border-b pb-2">Склад / Товары</h3>
                                <form onsubmit="window.createItem(event)" class="grid grid-cols-2 gap-3 mb-6 bg-gray-50 p-3 rounded">
                                    <input type="text" name="name" placeholder="Название" class="p-2 border rounded" required>
                                    <input type="text" name="type" placeholder="Тип (weapon/uniform/acc)" class="p-2 border rounded" required>
                                    <input type="number" name="price" placeholder="Цена" class="p-2 border rounded" required>
                                    <input type="text" name="desc" placeholder="Описание" class="p-2 border rounded" required>
                                    <button type="submit" class="col-span-2 bg-green-600 text-white py-1 rounded">Добавить товар</button>
                                </form>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    ${allItems.map(i => `
                                        <div class="flex justify-between items-center p-2 border rounded hover:bg-gray-50">
                                            <div><span class="font-bold">${i.name}</span> <span class="text-xs text-gray-500">${i.price} A</span></div>
                                            <button onclick="window.delItem('${i.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Управление Пользователями -->
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="font-bold text-lg mb-4 border-b pb-2">Личный состав</h3>
                                <form onsubmit="window.createUser(event)" class="grid grid-cols-2 gap-3 mb-6 bg-gray-50 p-3 rounded">
                                    <input type="text" name="username" placeholder="Логин" class="p-2 border rounded" required>
                                    <input type="text" name="password" placeholder="Пароль" class="p-2 border rounded" required>
                                    <input type="number" name="balance" placeholder="Баланс" class="p-2 border rounded" required>
                                    <button type="submit" class="col-span-2 bg-blue-600 text-white py-1 rounded">Создать бойца</button>
                                </form>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    ${allUsers.map(u => `
                                        <div class="p-2 border rounded hover:bg-gray-50">
                                            <div class="flex justify-between">
                                                <span class="font-bold text-gray-800">${u.username}</span>
                                                <span class="text-main font-mono">${u.balance} A</span>
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">Инвентарь: ${u.inventory ? u.inventory.length : 0} предметов</div>
                                            ${u.inventory && u.inventory.length > 0 ? `
                                                <div class="mt-2 pt-2 border-t border-dashed">
                                                    ${u.inventory.map((invItem, idx) => `
                                                        <span class="inline-flex items-center gap-1 bg-gray-200 text-[10px] px-1 rounded mr-1 mb-1">
                                                            ${invItem.name} 
                                                            <button onclick="window.revokeItem('${u.id}', ${idx})" class="text-red-600 font-bold">&times;</button>
                                                        </span>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Ликвидность -->
                             <div class="bg-white p-6 rounded-xl shadow-sm col-span-1 lg:col-span-2">
                                <h3 class="font-bold text-lg mb-2">Экономика</h3>
                                <div class="flex items-center gap-4">
                                    <p class="text-sm">Резерв обеспечения (USD):</p>
                                    <input type="number" id="liq-input" class="border p-1 rounded w-32">
                                    <button onclick="window.updateLiq()" class="bg-gray-800 text-white px-3 py-1 rounded text-sm">Обновить курс</button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'profile': // Мобильный профиль
                    html = `
                        <div class="bg-white p-6 rounded-xl shadow-sm text-center">
                            <div class="w-20 h-20 bg-gray-200 rounded-full mx-auto flex items-center justify-center mb-4">
                                <i data-lucide="user" class="w-10 h-10 text-gray-500"></i>
                            </div>
                            <h2 class="text-xl font-bold">${auth.currentUser.username}</h2>
                            <p class="text-main text-2xl font-bold mt-2">${auth.currentUser.balance.toFixed(2)} A</p>
                            <button onclick="auth.logout()" class="mt-6 text-red-600 border border-red-200 px-6 py-2 rounded-full w-full">Выйти</button>
                            
                            ${auth.isAdmin ? `<button onclick="router.navigate('admin')" class="mt-2 text-gray-600 bg-gray-100 px-6 py-2 rounded-full w-full">Админ панель</button>` : ''}
                        </div>
                    `;
                    break;
            }

            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- Глобальные функции для HTML обработчиков ---
        
        function getIconForType(type) {
            switch(type) {
                case 'weapon': return '<i data-lucide="crosshair" class="w-6 h-6 text-gray-700"></i>';
                case 'uniform': return '<i data-lucide="shirt" class="w-6 h-6 text-gray-700"></i>';
                case 'acc': return '<i data-lucide="glasses" class="w-6 h-6 text-gray-700"></i>';
                default: return '<i data-lucide="box" class="w-6 h-6 text-gray-700"></i>';
            }
        }

        window.buy = async (id, price) => {
            const items = await store.getItems();
            const item = items.find(i => i.id === id);
            if(confirm(`Купить ${item.name} за ${item.price} A-Coin?`)) {
                await store.buyItem(auth.currentUser.id, item);
            }
        };

        window.makeTransfer = async () => {
            const user = document.getElementById('transfer-username').value;
            const amount = document.getElementById('transfer-amount').value;
            await store.transferCoins(auth.currentUser.id, user, amount);
            document.getElementById('transfer-username').value = '';
            document.getElementById('transfer-amount').value = '';
        };

        // Admin functions global bind
        window.createItem = async (e) => {
            e.preventDefault();
            const form = e.target;
            await admin.addItem({
                name: form.name.value,
                type: form.type.value,
                price: parseFloat(form.price.value),
                description: form.desc.value
            });
            form.reset();
            renderApp();
        };

        window.delItem = async (id) => {
            await admin.deleteItem(id);
            renderApp();
        };

        window.createUser = async (e) => {
            e.preventDefault();
            const form = e.target;
            await admin.addUser(form.username.value, form.password.value, form.balance.value);
            form.reset();
            renderApp();
        };

        window.revokeItem = async (userId, idx) => {
            if(!confirm('Изъять предмет у игрока?')) return;
            // Нужно найти юзера
            const userSnap = await getDocs(query(collection(db, 'users'))); // не оптимально, но просто для примера
            const user = userSnap.docs.find(d => d.id === userId).data();
            await admin.removeItemFromUser(userId, idx, user.inventory);
            renderApp();
        };

        window.updateLiq = async () => {
            const val = document.getElementById('liq-input').value;
            if(val) await admin.updateLiquidity(val);
        };

        // Запуск
        setupListeners();
        if (auth.loadSession()) {
            initApp();
        }
    </script>
</body>
</html>